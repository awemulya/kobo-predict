{% extends "fieldsight/fieldsight_base.html" %}
{% load i18n staticfiles %}
{% load filters %}
{% block content %}
{% load filters %}
<style type="text/css">
    #removebutton{
    margin-top:33px;

    .dragPlaceholder {
        padding: 10px 15px;
      
      background: rgb(255,240,120);
      &:before {
        content: "Drop here";
        color: rgb(225,210,90);
      }
    }  
}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.4/css/selectize.bootstrap3.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.4/js/standalone/selectize.min.js"></script>
 <script src="{% static 'js/formparser.js' %}"></script>
 <script src="{% static 'js/reactjs/react.min.js' %}"></script>
 <script src="{% static 'js/reactjs/browser.min.js' %}"></script>
 <script src="{% static 'js/reactjs/react-dom.min.js' %}"></script>


            <div id="main-content" class="padding">
                <nav aria-label="breadcrumb" role="navigation">
                    {% block breadcrumbs %}
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'fieldsight:project-dashboard' obj.pk %}">{{ obj.name }}</a></li>
                        <li class="breadcrumb-item active" aria-current="page">{% trans 'Meta' %} {% trans 'Attributes' %} {% trans 'Upload' %}</li>
                     </ol>
                    {% endblock %}
                </nav>

                <section id="app" class="panel">
                   
                    

                </section>
                   
                    <form id="theForm" action="{% url 'fieldsight:define-site-meta' obj.pk %}" method="post">
                    {% csrf_token %}
                      <input name="json_questions" id="json_questions" type="hidden" value="" />
                    </form> 

            </div>
{% endblock %}

{%block extrascript %}
<script>
{% load l10n %}
</script>

    <script type="text/babel">

     var _json_question = JSON.parse("{{json_questions|escapejs}}");
     var project_id = "{{ obj.id|unlocalize }}";
     var org_id = "{{ obj.organization_id|unlocalize }}";

     var questionTypes = [{'id': 'Text', 'name': 'Text'}, 
                          {'id': 'Number', 'name': 'Number'},
                          {'id': 'Date', 'name': 'Date'},
                          {'id': 'MCQ', 'name': 'Select one'},
                          {'id': 'Link', 'name': 'Draw from another project'},
                          {'id': 'Form', 'name': 'Draw answer from a form'},
                          {'id': 'FormSubStat', 'name': 'Form submission'}, ];
     
    var SelectComponent = React.createClass({
            
            getInitialState: function () {
                return {}
            },
   
            renderNormal:function(){
                return(
                        <select ref={this.props.inputRef} className="form-control" name="project" onChange={this.props.onChangeFunction} value={this.props.defaultValue}>
                            {this.props.options.map((e, key) => {
                                return <option key={key} value={this.props.isProject ? key : e.id}>{e.name}</option>;
                            })}
                        </select>
                    );
            },
            render: function () {
                    return this.renderNormal();
            }
        });

    var FormSelectComponent = React.createClass({
            
            getInitialState: function () {
                return {}
            },
   
            renderNormal:function(){
                return(
                    <select ref={this.props.inputRef} className="form-control" name="project" onChange={this.props.onChangeFunction} value={this.props.defaultValue}>
                        {Object.keys(this.props.questions).map((e, key) => {
                            return <option key={key} value={e}>{this.props.questions[e].label}</option>;
                        })}
                    </select>          
                    );
            },
            render: function () {
                    return this.renderNormal();
            }
        });



    var CheckboxComponent = React.createClass({
            
            
            getInitialState: function () {
                return {isloaded:false, metas:[], project_id:0, selected_metas:[], indent:0}
            },

            loadmetas: function(metas, project_id, selected_metas, indent){
                this.setState({'metas':metas, 'project_id':project_id, 'selected_metas':selected_metas, 'indent':indent}) 
            },
            componentDidMount(){
                this.loadmetas(this.props.metas, this.props.project_id, this.props.selected_metas, this.props.indent || 0);
            },
            componentWillReceiveProps(nextProps) {
                this.loadmetas(nextProps.metas, nextProps.project_id, nextProps.selected_metas, this.props.indent || 0);
            },
            
            toggleCheckbox:function(index, obj) {
                this.props.updateSelectedMetas(this.state.project_id, obj);

            },

            eachMeta: function (obj, j){            
               
                const style={
                            'margin-left': this.props.indent+'px',
                        }
                if(obj.question_type=='Link'){
                    if (obj.project_id.toString() != project_id.toString()){
                    
                    const submetas = [];
                    if((this.state.selected_metas[this.state.project_id] || []).find(temp=>temp.question_name == obj.question_name)){
                    submetas.push(
                         <CheckboxComponent project_id={obj.project_id} metas={obj.metas[obj.project_id]} selected_metas={this.state.selected_metas} indent={this.state.indent + 20} updateSelectedMetas={this.props.updateSelectedMetas}/>
                        )
                    }
                    return (
                        <div>
                        <br/>

                        <div style={style}>
                            <label>
                                <input
                                    type="checkbox"
                                    checked={(this.state.selected_metas[this.state.project_id] || []).find(temp=>temp.question_name == obj.question_name)}
                                    onChange={this.toggleCheckbox.bind(this, j, obj)}
                                />
                                <b>
                                {obj.question_text}
                                </b>
                                </label>
                        </div>
                        {
                            submetas
                        }</div>
                        )
                    }
                }
                else{
                return(
                <div style={style}>
                    <label>
                        <input
                            type="checkbox"
                            checked={(this.state.selected_metas[this.state.project_id] || []).find(temp=>temp.question_name == obj.question_name)}
                            onChange={this.toggleCheckbox.bind(this, j, obj)}
                        />
                        {obj.question_text}
                        </label>
                </div>)
                }
            },
                          
            renderNormal:function(){
                
                return (<div>
                    {         
                        this.state.metas.map(this.eachMeta)
                    }
                </div>
            );
            },
            render: function () {
                    return this.renderNormal();
            }
        });

     var NormalQuestion = React.createClass({
            
            getInitialState: function () {
                return {questionTypes:questionTypes, editing:false | this.props.is_new}
            },

            save: function () {
                this.props.updateQuestionText(this.refs.newText.value, this.refs.questionType.value, this.refs.placeholder.value, this.refs.helpText.value, this.props.index);
                 console.log('save', this.refs.helpText.value);
            },
            
            remove:function(){
                // console.log('Delete pressed.')
                this.props.deleteFromForm(this.props.index);
            },

            edit: function () {
                this.setState({editing:true})
            },

            editDone: function () {
                if (this.props.is_new){
                    this.props.addtoForm(this.props.index);
                    this.setState({editing:false})
                }
                else{
                    this.setState({editing:false})
                }
                // console.log('save');
            },

            renderNormal:function(){
                return(
                    <div className="form-field-item margin-top">
                        <div className="form-group">
                            <label for="input11" className="col-form-label">{this.props.question}:</label>
                            <span className="field-type"><strong>Type : </strong>{this.props.question_type}</span>
                            <div className="clearfix"></div>
                            <input type="text" className="form-control" id="input11" defaultValue={ 'question_placeholder' in this.props.question_obj ? this.props.question_obj.question_placeholder:""} placeholderText={ 'question_help' in this.props ? this.props.question_help:""}/>
                            <small id="input1Help" className="form-text text-muted">{ 'question_help' in this.props.question_obj ? this.props.question_obj.question_help:""}</small>
                        </div>
                        <div className="form-action">
                            <button className="btn btn-sm btn-primary" onClick={this.edit}><i className="la la-edit"></i></button>
                            <br/>
                            <button className="btn btn-sm btn-danger" onClick={this.remove}><i className="la la-close"></i></button>
                        </div>
                    </div>
                );
            },
            renderForm:function(){
                return(

                        <div className="form-field-item margin-top">
                            <div className="form-group">
                                <label for="input1" className="col-form-label">Input Label:</label>
                                <input type="text" ref="newText" className="form-control" onChange={this.save} placeholderText="Attribute Label" defaultValue={this.props.question}></input>
                                <small className="form-text text-muted">Text in this field will appear as a label for your form field.</small>
                            </div>

                            <div className="form-group">
                                <label className="col-form-label">Input Type:</label>
                                    <SelectComponent inputRef={el => this.refs.questionType = el} onChangeFunction={this.save} defaultValue={this.props.question_type} options={this.state.questionTypes}/>
                                <small id="input1Help" className="form-text text-muted">Type of input you want.</small>
                            </div>

                            <div className="form-group">
                                <label className="col-form-label">Placeholder:</label>
                                <input type="text" ref="placeholder" className="form-control" onChange={this.save} placeholderText="Placeholder" defaultValue={ 'question_placeholder' in this.props.question_obj ? this.props.question_obj.question_placeholder:""}></input>
                                <small className="form-text text-muted">Description for this field</small>
                            </div>
                            <div className="form-group">
                                <label className="col-form-label">Help Text:</label>
                                <textarea ref="helpText" className="form-control" value={ 'question_help' in this.props.question_obj ? this.props.question_obj.question_help:""} onChange={this.save}/>
                                <small id="input1Help" className="form-text text-muted">Description for this field</small>
                            </div>

                            <button type="submit" className="btn btn-primary" onClick={this.editDone}><i className={this.props.is_new ? 'la la-plus':'la la-check'}></i> { this.props.is_new ? 'Add to Form':'Preview'}</button>

                        </div>

                    
                );
            },
            render: function () {
                    if(this.state.editing){
                        return this.renderForm();
                    }
                    else{
                        return this.renderNormal();   
                    }
            }
        });



     var Option = React.createClass({
            
            getInitialState: function () {
                return {editing: true}
            },
            
            edit:function(){
               this.setState({editing: true});
            },

            save: function () {
                this.props.updateOption(this.refs.newOptionText.value, this.props.index);
                // console.log('save');
            },
            
            remove:function(){
                // console.log('Delete pressed.' + this.props.index)
                this.props.deleteOption(this.props.index);
            },            
   
            renderNormal:function(){
                return(
                    <div className="QuestionContainer form-row">
                        <div className="form-group col-md-9">
                            <label for="input1" className="col-form-label">Option {this.props.index + 1}:</label>
                            <input type="text" ref="newOptionText" className="form-control" onChange={this.save} defaultValue={this.props.option_text} placeholder= "Option Text"></input>
                        </div>
                        <div className="form-group col-md-3">
                            <label className="col-form-label"> &nbsp; </label>                     
                            <button className="btn btn-danger" type="button" id="removebutton" onClick={this.remove}><i className="la la-close"></i>Remove</button>
                        </div>
                    </div>
                );
            },
            render: function () {
                return this.renderNormal();
            }
        });

      var MCQQuestion = React.createClass({
            getInitialState: function () {
                return {questionTypes:questionTypes, options:this.props.options, editing:false | this.props.is_new}
            },
            
            addOption:function () {
                var arr =this.state.options;
                var new_option={"option_text":""};
                arr.push(new_option);
                this.setState({options: arr});
            },

            save: function () {
                this.props.updateMCQOptions(this.state.options, this.props.index);
                this.props.updateQuestionText(this.refs.newText.value, this.refs.questionType.value, "", this.refs.helpText.value, this.props.index);
            },

            updateOption: function(newTextoption, i){
                var arr= this.state.options;
                arr[i].option_text = newTextoption;
                this.setState({options: arr});
                this.props.updateMCQOptions(this.state.options, this.props.index);

            },

            deleteOption: function(i){
                var arr= this.state.options;
                arr[i].is_deleted=true;
                this.setState({options:arr})               
                this.props.updateMCQOptions(this.state.options, this.props.index);
            },

            remove:function(){
                //console.log('Delete pressed.')
                this.props.deleteFromForm(this.props.index);
            },
            
            edit: function () {
                this.setState({editing:true})
            },

            editDone: function () {
                if (this.props.is_new){
                    this.props.addtoForm(this.props.index);
                    this.setState({editing:false})
                }
                else{
                    this.setState({editing:false})
                }
                // console.log('save');
            },

            eachOption: function (obj, j){
                // console.log(text);
                if(!obj.hasOwnProperty('is_deleted')){
                return(
                    <Option key={j} index={j} option_text={obj.option_text} deleteOption={this.deleteOption} updateOption={this.updateOption}/>
                    );
                 }},
            renderNormal:function(){
                var optionslist = [{'option_text' :false}].concat(this.props.options);
                var options = optionslist.map(function(item) {
                  
                      if(item.option_text === false){
                          return <option value={""}> 
                              Please select and option
                             </option>;
                          }        
                    return <option value = {
                      item.option_text
                    } > {
                      item.option_text
                    } </option>;
                  

                })
                return(
                    <div className="form-field-item margin-top">
                        <div className="form-group">
                            <label for="input11" className="col-form-label">{this.props.question}:</label>
                            <span className="field-type"><strong>Type : </strong> Select</span>
                                <div className="clearfix"></div>
                                <select className="form-control"> 
                                  {options} 
                                </select>   
                                                
                            <small id="input1Help" className="form-text text-muted">{ 'question_help' in this.props.question_obj ? this.props.question_obj.question_help:""}</small>
                                
                        </div>
                        <div className="form-action">
                            <button className="btn btn-sm btn-primary" onClick={this.edit}><i className="la la-edit"></i></button>
                            <br/>
                            <button className="btn btn-sm btn-danger" onClick={this.remove}><i className="la la-close"></i></button>
                        </div>
                    </div>
                );
            },

            renderForm:function(){
                return(
                     <div className="form-field-item margin-top">
                        <div className="form-group">
                                <label for="input1" className="col-form-label">Input Label:</label>
                                <input type="text" ref="newText" className="form-control" onChange={this.save} placeholder="Attribute Label" defaultValue={this.props.question}></input>
                            </div>
                            <div className="form-group">
                                <label for="input2" className="col-form-label">Input Type:</label>
                                <SelectComponent inputRef={el => this.refs.questionType = el} onChangeFunction={this.save} defaultValue={this.props.question_type} options={this.state.questionTypes}/>
                            </div>
                            <div className="form-group">
                                <label className="col-form-label">Help Text:</label>
                                <textarea ref="helpText" className="form-control" value={ 'question_help' in this.props.question_obj ? this.props.question_obj.question_help:""} onChange={this.save}/>
                                <small id="input1Help" className="form-text text-muted">Description for this field</small>
                            </div>
                        {         
                            this.state.options.map(this.eachOption)
                        }
                    <button onClick={this.addOption} className="btn btn-primary"><i className="la la-plus"></i> Option</button><hr/>
                    <button className="btn btn-primary" onClick={this.editDone}><i className={this.props.is_new ? 'la la-plus':'la la-check'}></i> { this.props.is_new ? 'Add to Form':'Preview'}</button>            
                    </div>
                );
            },
            render: function () {
                if(this.state.editing){
                    return this.renderForm();
                }
                else{
                    return this.renderNormal();   
                }
            }
        });

    var ExtLinkQuestion = React.createClass({
            
            getInitialState: function () {
                
                return {questionTypes:questionTypes, editing:false | this.props.is_new, isLoaded: false, projects:this.props.projects, project_index:0, selected_metas:this.props.selected_metas, metas:[], project_id: this.props.link_project_id}
            },

            componentDidMount() {
                this.setState({isLoaded: false});
                let project_index=this.state.projects.indexOf(this.state.projects.find(temp=>temp.id == this.state.project_id));
                if (project_index < 0){ project_index = 0; }
                this.setState({project_index:project_index, projects:this.props.projects, metas:this.props.projects[project_index].site_meta_attributes,  isLoaded: true});
               
              },
            componentWillReceiveProps(nextProps) {
                this.setState({isLoaded: false});
                let project_index=nextProps.projects.indexOf(nextProps.projects.find(temp=>temp.id == nextProps.link_project_id));
                if (project_index < 0){ project_index = 0; }
                this.setState({project_index:project_index, projects:nextProps.projects, selected_metas:nextProps.selected_metas, metas:nextProps.projects[project_index].site_meta_attributes,  isLoaded: true});
            },

            save: function () {
                this.props.updateQuestionText(this.refs.newText.value, this.refs.questionType.value, "", this.refs.helpText.value, this.props.index);
                // console.log('save');
            },
            

            updateSelectedMetas: function(project_id, obj){
                this.props.updateLinkMetas(project_id, this.props.index, obj);
            },

            projectChanged: function () {
                const selectedProject = this.state.projects[this.refs.selectProjectRef.value]
                if (this.props.selectedProjectLinkIds.indexOf(selectedProject.id) > -1){
                    alert("Project already selected");
                    //this.setState({project_index:0});
                    // console.log(this.props.selectedProjectLinkIds, this.state.project_index);
                }else{
                    this.props.updateLinkProject(selectedProject.id, this.props.index);
                    
                    //console.log(selectedProject.site_meta_attributes);
                    this.setState({project_index:this.refs.selectProjectRef.value, project_id:selectedProject.id, metas:selectedProject.site_meta_attributes});
                    //console.log(selectedProject.id);
                    //CLEAR ALL SELECTED METAS ON CHANGE
                }
            },

            remove:function(){
                // console.log('Delete pressed.')
                this.props.deleteFromForm(this.props.index);
            },

            edit: function () {
                this.setState({editing:true})
            },

            editDone: function () {
                if (this.props.is_new){
                    this.props.addtoForm(this.props.index);
                    this.setState({editing:false})
                }
                else{
                    this.setState({editing:false})
                }
                // console.log('save');
            },

            renderNormal:function(){
                if(this.state.isLoaded){
                    return(

                             <div className="form-field-item margin-top">
                                <div className="form-group">
                                    <label for="input11" className="col-form-label">{this.props.question}:</label>
                                    <span className="field-type"><strong>Type : </strong> Select</span>
                                        <div className="clearfix"></div>
                                        <select className="form-control" id="input13">
                                            <option>Site 1</option>
                                            <option>Site 2</option>
                                            <option>Site 3</option>
                                            <option>Site 4</option>
                                        </select>
                                                        
                                    <small id="input1Help" className="form-text text-muted">{ 'question_help' in this.props.question_obj ? this.props.question_obj.question_help:""}</small>
                                </div>
                                <div className="form-action">
                                    <button className="btn btn-sm btn-primary" onClick={this.edit}><i className="la la-edit"></i></button>
                                    <br/>
                                    <button className="btn btn-sm btn-danger" onClick={this.remove}><i className="la la-close"></i></button>
                                </div>
                            </div>
                       
                   ); 
                }else{
                     return(
                        <div className="form-field-item margin-top"> 
                            <div className="form-field-item">
                                <div className="form-group">
                                    <label for="input11" className="col-form-label">Loading ... </label>
                                    
                                </div>
                            
                            </div>
                        </div>
                        );
                }
            },

            renderForm:function(){
                if(this.state.isLoaded){
                    return(
                    <div className="form-field-item margin-top">
                        <div className="form-group">
                            <label for="input1" className="col-form-label">Input Label:</label>
                            <input type="text" ref="newText" className="form-control" onChange={this.save} placeholder="Attribute Label" defaultValue={this.props.question}></input>
                        </div>
                        <div className="form-group">
                            <label for="input2" className="col-form-label">Input Type:</label>
                            <SelectComponent inputRef={el => this.refs.questionType = el} onChangeFunction={this.save} defaultValue={this.props.question_type} options={this.state.questionTypes}/>
                        </div>
                        <div className="form-group">
                            <label className="col-form-label">Help Text:</label>
                            <textarea ref="helpText" className="form-control" value={ 'question_help' in this.props.question_obj ? this.props.question_obj.question_help:""} onChange={this.save}/>
                            <small id="input1Help" className="form-text text-muted">Description for this field</small>
                        </div>
                        <div className="form-group">
                            <label className="col-form-label">Select Project</label>                     
                            <SelectComponent inputRef={el => this.refs.selectProjectRef = el} isProject={true} onChangeFunction={this.projectChanged} defaultValue={this.state.project_index} options={this.props.projects} />
                        </div>
                        <CheckboxComponent project_id={this.state.project_id}  selected_metas={this.state.selected_metas} metas={this.state.metas} updateSelectedMetas={this.updateSelectedMetas}/>
                        <button className="btn btn-primary" onClick={this.editDone}><i className={this.props.is_new ? 'la la-plus':'la la-check'}></i> { this.props.is_new ? 'Add to Form':'Preview'}</button>  
                    </div>
                   ); 
                }else{
                     return(
                        <div className="form-field-item">
                            <div className="form-group">
                                <label for="input11" className="col-form-label">Loading ... </label>
                                
                            </div>
                        
                        </div>);
                }
            },
            render: function () {
                if(this.state.editing){
                        return this.renderForm();
                    }
                    else{
                        return this.renderNormal();   
                }
            }
        });

var FormSubStatQuestion = React.createClass({
            
            getInitialState: function () {
                return {questionTypes:questionTypes, editing:false | this.props.is_new, isLoaded: false, forms:this.props.forms, form_index:0, form_id: this.props.link_form_id}
            },

            componentDidMount() {
                this.setState({isLoaded: false});
                let form_index=this.state.forms.indexOf(this.state.forms.find(temp=>temp.id == this.state.form_id));
                if (form_index < 0){ form_index = 0; }
                this.setState({form_index:form_index, forms:this.props.forms, isLoaded: true});
            },

            componentWillReceiveProps(nextProps) {
                this.setState({isLoaded: false});
                let form_index=nextProps.forms.indexOf(nextProps.forms.find(temp=>temp.id == nextProps.link_form_id));
                if (form_index < 0){ form_index = 0; }
                this.setState({form_index:form_index, forms:nextProps.forms, selected_question:nextProps.selected_question,  isLoaded: true});
            },

            save: function () {
                this.props.updateQuestionText(this.refs.newText.value, this.refs.questionType.value, "","", this.props.index);
            },
            
            formChanged: function () {
                const selectedForm = this.state.forms[this.refs.selectFormRef.value]    
                this.props.updateForm(selectedForm.id, this.props.index);
                this.setState({form_index:this.refs.selectFormRef.value, form_id:selectedForm.id}); 
            },

            remove:function(){
                this.props.deleteFromForm(this.props.index);
            },

            edit: function () {
                this.setState({editing:true})
            },

            editDone: function () {
                if (this.props.is_new){
                    this.props.addtoForm(this.props.index);
                    this.setState({editing:false})
                }
                else{
                    this.setState({editing:false})
                }
                // console.log('save');
            },

            renderNormal:function(){
                if(this.state.isLoaded){
                    return(
                    
                        <div className="form-field-item margin-top">
                            <div className="form-group">
                                <label className="col-form-label">{this.props.question}:</label>
                                <span className="field-type"><strong>Type : </strong>{this.props.question_type}</span>
                                    <div className="clearfix"></div>
                                    <span>Yes / No</span> 

                            </div>
                            <div className="form-action">
                                <button className="btn btn-sm btn-primary" onClick={this.edit}><i className="la la-edit"></i></button>
                                <br/>
                                <button className="btn btn-sm btn-danger" onClick={this.remove}><i className="la la-close"></i></button>
                            </div>
                        </div>
                   
                   ); 
                }else{
                     return(
                        <div className="form-field-item margin-top"> 
                            <div className="form-field-item">
                                <div className="form-group">
                                    <label for="input11" className="col-form-label">Loading ... </label>
                                    
                                </div>
                            
                            </div>
                        </div>);
                }
            },    
            renderForm:function(){
                if(this.state.isLoaded){
                    return(
                    <div className="form-field-item margin-top">
                        <div className="form-group">
                            <label for="input1" className="col-form-label">Input Label:</label>
                            <input type="text" ref="newText" className="form-control" onChange={this.save} placeholder="Attribute Label" defaultValue={this.props.question}></input>
                        </div>
                        <div className="form-group">
                            <label for="input2" className="col-form-label">Input Type:</label>
                            <SelectComponent inputRef={el => this.refs.questionType = el} onChangeFunction={this.save} defaultValue={this.props.question_type} options={this.state.questionTypes}/>
                        </div>
                        <div className="form-group">
                            <label className="col-form-label">Select a Form</label>                     
                            <SelectComponent inputRef={el => this.refs.selectFormRef = el} isProject={true} onChangeFunction={this.formChanged} defaultValue={this.state.form_index} options={this.props.forms} />
                        </div>    
                        <button className="btn btn-primary" onClick={this.editDone}><i className={this.props.is_new ? 'la la-plus':'la la-check'}></i> { this.props.is_new ? 'Add to Form':'Preview'}</button>  
                    </div>
                   ); 
                }else{
                     return(
                        <div className="form-field-item">
                            <div className="form-group">
                                <label for="input11" className="col-form-label">Loading ... </label>     
                            </div>
                        </div>);
                }   
            },
            render: function () {
                if(this.state.editing){
                        return this.renderForm();
                    }
                    else{
                        return this.renderNormal();   
                }
            }
        });


    var FormQuestion = React.createClass({
            
            getInitialState: function () {
                return {questionTypes:questionTypes, editing:false | this.props.is_new, isLoaded: false, forms:this.props.forms, form_index:0, selected_question:this.props.selected_question, questions:[], processed_questions:{}, form_id: this.props.link_form_id}
            },

            componentDidMount() {
                this.setState({isLoaded: false});
                let form_index=this.state.forms.indexOf(this.state.forms.find(temp=>temp.id == this.state.form_id));
                var questions = {};
                if (form_index < 0){ 
                    form_index = 0; 
                }
                else{
                    questions = parse_form_response(this.props.forms[form_index].json['children']);
                }
                this.setState({form_index:form_index, forms:this.props.forms,  processed_questions: questions, isLoaded: true});
                
            },

            componentWillReceiveProps(nextProps) {
                this.setState({isLoaded: false});
                let form_index=nextProps.forms.indexOf(nextProps.forms.find(temp=>temp.id == nextProps.link_form_id));
                var questions = {};
                if (form_index < 0){ 
                    form_index = 0; 
                }
                else{
                    questions = parse_form_response(nextProps.forms[form_index].json['children']);
                }
                this.setState({form_index:form_index, forms:nextProps.forms, processed_questions: questions, selected_question:nextProps.selected_question,  isLoaded: true});
            },

            save: function () {
                this.props.updateQuestionText(this.refs.newText.value, this.refs.questionType.value, "","", this.props.index);
                // console.log('save');
            },
            

            questionChanged: function(){
                let question_name = this.refs.formselectQuestionRef.value;
                let selected_question = this.state.processed_questions[question_name]
                console.log(selected_question);
                this.props.updateSQuestion(selected_question, this.props.index);
            },

            // updateSelectedQuestion: function(form_id, obj){
            //     this.props.updateFormQuestion(form_id, this.props.index, obj);
            // },

            formChanged: function () {
                // let questions = parse_form_response(this.props.forms[this.state.form_index].json['children']);
                // this.setState({processed_questions:questions})
                console.log(this.refs.selectFormRef.value);
                console.log(this.state.forms);
                const selectedForm = this.state.forms[this.refs.selectFormRef.value]
                
                this.props.updateForm(selectedForm.id, this.props.index);
                    
                    //console.log(selectedProject.site_meta_attributes);
                this.setState({form_index:this.refs.selectFormRef.value, form_id:selectedForm.id});
                    //console.log(selectedProject.id);
                    //CLEAR ALL SELECTED METAS ON CHANGE
                
            },

            remove:function(){
                // console.log('Delete pressed.')
                this.props.deleteFromForm(this.props.index);
            },

            edit: function () {
                this.setState({editing:true})
            },

            editDone: function () {
                if (this.props.is_new){
                    this.props.addtoForm(this.props.index);
                    this.setState({editing:false})
                }
                else{
                    this.setState({editing:false})
                }
                // console.log('save');
            },

            renderNormal:function(){
                if(this.state.isLoaded){
                    return(
                     
                         <div className="form-field-item margin-top">
                            <div className="form-group">
                                <label for="input11" className="col-form-label">{this.props.question}:</label>
                                <span className="field-type pull-right"><strong>Type : </strong>{this.props.question_type}</span>
                                    <div className="clearfix"></div>
                                    <span>Yes/No</span>
                                                    
                                
                            </div>
                            <div className="form-action">
                                <button className="btn btn-sm btn-primary" onClick={this.edit}><i className="la la-edit"></i></button>
                                <br/>
                                <button className="btn btn-sm btn-danger" onClick={this.remove}><i className="la la-close"></i></button>
                            </div>
                        </div>
                    
                   ); 
                }else{
                     return(
                        <div className="form-field-item margin-top">
                            <div className="form-field-item">
                                <div className="form-group">
                                    <label for="input11" className="col-form-label">Loading ... </label>    
                                </div>
                            </div>
                        </div>
                        );
                }
            },    
            renderForm:function(){
                // console.log(questions);
                if(this.state.isLoaded){
                    return(
                    <div className="form-field-item margin-top">
                        <div className="form-group">
                            <label for="input1" className="col-form-label">Input Label:</label>
                            <input type="text" ref="newText" className="form-control" onChange={this.save} placeholder="Attribute Label" defaultValue={this.props.question}></input>
                        </div>
                        <div className="form-group">
                            <label for="input2" className="col-form-label">Input Type:</label>
                            <SelectComponent inputRef={el => this.refs.questionType = el} onChangeFunction={this.save} defaultValue={this.props.question_type} options={this.state.questionTypes}/>
                        </div>
                        <div className="form-group">
                            <label className="col-form-label">Select a Form</label>                     
                            <SelectComponent inputRef={el => this.refs.selectFormRef = el} isProject={true} onChangeFunction={this.formChanged} defaultValue={this.state.form_index} options={this.props.forms} />
                        </div>

                        <div className="form-group">
                            <label className="col-form-label">Select a Question</label>                     
                            <FormSelectComponent inputRef={el => this.refs.formselectQuestionRef = el} onChangeFunction={this.questionChanged} defaultValue={this.state.selected_question} questions={this.state.processed_questions} />
                        </div>
                        <button className="btn btn-primary" onClick={this.editDone}><i className={this.props.is_new ? 'la la-plus':'la la-check'}></i> { this.props.is_new ? 'Add to Form':'Preview'}</button>  
                    </div>
                   ); 
                }else{
                     return(
                        <div className="form-field-item margin-top"> 
                            <div className="form-field-item">
                                <div className="form-group">
                                    <label for="input11" className="col-form-label">Loading ... </label>
                                    
                                </div>
                            
                            </div>
                        </div>
                        );
                }
                
                
            },
            render: function () {
                if(this.state.editing){
                        return this.renderForm();
                    }
                    else{
                        return this.renderNormal();   
                }
            }
        });

        var dragPlaceholder = document.createElement("li");
        dragPlaceholder.className = "dragPlaceholder ui-sortable-handle margin-top";
        dragPlaceholder.style.height = "100px";
        dragPlaceholder.style.background= "rgb(255,240,120)";

     var Form = React.createClass({
        getInitialState: function () {
            
            //console.log(linkTypeObjs);
            return {
                Questions: _json_question.concat([{
                    "question_text": "",
                    "question_type": "Text",
                    "question_name": "",
                    "question_placeholder": "",
                    "question_help": "",
                    "is_new": true,
                }]),
                projects: [{id:0, name:"Select project", site_meta_attributes:[]}],
                selectedProjectLinkIds:[],
                isLoaded: false,
                forms: [{id:0, name:"Select form", json:{ children: []}}],
            }
        },

            componentDidMount() {
                
                const linkTypeObjs =_json_question.filter(function (obj) {
                        return obj.question_type == "Link" ;
                    }).map(x => x.project_id);

                fetch("/fieldsight/api/organization/"+org_id+"/my_projects/"+project_id+"/", {
                      method: 'GET',
                      credentials: 'include'
                    })
                  .then(res => res.json())
                  .then(
                    (result) => {
                        const project_options = this.state.projects.concat(result);
                        this.setState({
                            projects: project_options,
                            selectedProjectLinkIds: linkTypeObjs,
                            isLoaded: true,
                        });
                    },
                    (error) => {
                      this.setState({
                        isLoaded: true,
                      });
                    }
                  )

                  fetch("/fieldsight/api/project/forms/"+project_id+"/", {
                      method: 'GET',
                      credentials: 'include'
                    })
                  .then(res => res.json())
                  .then(
                    (result) => {
                        const form_options = this.state.forms.concat(result);
                        this.setState({
                            forms: form_options,
                            isLoaded: true,
                        });
                    },
                    (error) => {
                        this.setState({
                            isLoaded: true,
                        });
                    }
                  )
              },

    // var question = {
    //         "question_text": "",
    //         "question_type": "Text",
    //         "question_name": ""
    //     },
    // addQuestion: function (text) {
    //     var arr =this.state.Questions;

    //     var question = {
    //         "question_text": "",
    //         "question_type": "Text",
    //         "question_name": this.state.Questions.toString()
    //     }
    //     arr.push(question);

    //     this.setState({Questions: arr});
    // },
    dragStart: function(e) {
    this.dragged = e.currentTarget;
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.dragged);
    },

    dragEnd: function(e) {
        this.dragged.style.display = 'block';
        this.dragged.parentNode.removeChild(dragPlaceholder);

    // update state
        var questions = this.state.Questions;
        var from = Number(this.dragged.dataset.id);
        var to = Number(this.over.dataset.id);
        if(from < to) to--;
        questions.splice(to, 0, questions.splice(from, 1)[0]);
        this.setState({Questions: questions});
    },
    
    dragOver: function(e) {
        e.preventDefault();
        // this.dragged.clientHeight > 0 ? dragPlaceholder.style.height = this.dragged.clientHeight  
        this.dragged.style.display = "none";
        console.log(e.target.closest("li"));
        if(e.target.className === 'elementdrag') return;
        
        if(e.target.closest("li") == null || e.target.closest("li").className != "ui-sortable-handle") return;
        this.over = e.target.closest("li");
        e.target.closest("li").parentNode.insertBefore(dragPlaceholder, e.target.closest("li"));
        
    },

    save: function () {  
        if(this.state.Questions.length < 1){ return alert("No Any Questions Found."); } 
        var is_form_valid = true;
        console.log(is_form_valid);
        var json_convertible = this.state.Questions.filter(function(item) {
           
            if (item.hasOwnProperty('is_deleted') && item.is_deleted == false){
                delete item.is_deleted;
            }

            if (!item.hasOwnProperty('is_deleted') && !item.hasOwnProperty('is_new')){
                if (item.question_text == ""){
                    console.log(item.question_text);
                    is_form_valid = false;
                    return false;
                }
                return item;
            }
    });
        console.log(is_form_valid);
        
        if (is_form_valid === false){ return alert("The question text cannot be blank.");}
        for (var key in json_convertible) {
            json_convertible[key].question_name = json_convertible[key].question_text.replace(/\W/g,"_");
        }
        var json_Question = JSON.stringify(json_convertible);
        document.getElementById('json_questions').value = json_Question;
        document.getElementById('theForm').submit();
    },

    removeQuestion: function(i){
        var arr= this.state.Questions;
        var selectedProjectLinkIds = this.state.selectedProjectLinkIds
        arr[i].is_deleted=true;
        if (arr[i].question_type == "Link"){
            var index = selectedProjectLinkIds.indexOf(arr[i].project_id);
            if (index > -1) {
              selectedProjectLinkIds.splice(index, 1);
            }
        }
        this.setState({Questions: arr, selectedProjectLinkIds: selectedProjectLinkIds});
    },


    updateQuestion: function (newtext, questionType, placeholder, help, i) {
        var arr = this.state.Questions;

        if (arr[i].question_type == "MCQ" && questionType != "MCQ"){
            delete arr[i].mcq_options; 
        }
        else if(arr[i].question_type == "Link" && questionType != "Link"){
            delete arr[i].project_id;
            delete arr[i].metas;
        }
        else if(arr[i].question_type == "Form" && questionType != "Form"){
            delete arr[i].form_id;
            delete arr[i].question;
        }
        else if(arr[i].question_type == "FormSubStat" && questionType != "FormSubStat"){
            delete arr[i].form_id;
        }

        if(questionType == "MCQ" && arr[i].question_type != "MCQ"){
            arr[i].mcq_options=[];
        }
        else if(questionType == "Link" && arr[i].question_type != "Link"){
            arr[i].project_id = 0;
            arr[i].metas={};
        }
        else if(questionType == "Form" && arr[i].question_type != "Form"){
            arr[i].form_id = 0;
            arr[i].question={};
        }
        else if(questionType == "FormSubStat" && arr[i].question_type != "FormSubStat"){
            arr[i].form_id = 0;
        }

        arr[i].question_text=newtext;
        arr[i].question_type=questionType;
        arr[i].question_placeholder=placeholder;
        arr[i].question_help=help;
        this.setState({Questions:arr});
    },

    updateMCQOptions: function (options, i){
        var arr = this.state.Questions;
        var newOptionsArray = options.filter(function (op) {
        if (!op.hasOwnProperty('is_deleted')){
            return op
            }
        });
        arr[i].mcq_options=newOptionsArray;
        this.setState({Questions:arr});
    },

    updateLinkProject: function (project_id, i){
        var arr = this.state.Questions;
        var selectedProjectLinkIds = this.state.selectedProjectLinkIds
        var prev_project_id = arr[i].project_id
        arr[i].project_id=project_id;
        arr[i].metas = {};
        var index = selectedProjectLinkIds.indexOf(prev_project_id);
        if (index > -1) {
          selectedProjectLinkIds.splice(index, 1);
        }
        selectedProjectLinkIds.push(project_id);
        console.log(selectedProjectLinkIds);
        this.setState({Questions:arr, selectedProjectLinkIds: selectedProjectLinkIds});
    },

    updateForm: function (form_id, i){
        var arr = this.state.Questions;
        arr[i].form_id=form_id;
        if (arr[i].question_type == "Form"){
            arr[i].question = {};
        }
        this.setState({Questions:arr});

        //console.log("updatingLinkproject_id");
        // console.log(this.state.forms);
    },


    updateSQuestion: function (obj, i){
        var arr = this.state.Questions;
        arr[i].question = obj;
        this.setState({Questions:arr});

        //console.log("updatingLinkproject_id");
        // console.log(this.state.forms);
    },


    updateIndividualLink: function (project_id, i, obj){
        var arr = this.state.Questions;
        if (project_id in arr[i].metas){
            const obj_exists = arr[i].metas[project_id].find(temp=>temp.question_name == obj.question_name)
        
            if (obj_exists){
                arr[i].metas[project_id].splice(arr[i].metas[project_id].indexOf(obj_exists), 1);
                
            }
            else{
                arr[i].metas[project_id].push(obj);
            }
        }
        else{
            arr[i].metas[project_id]=[obj];
        }
        this.setState({Questions:arr});
    },

    updateLinkMetas: function (project_id, i, obj){
        
        this.updateIndividualLink(project_id, i, obj);
        // if (obj['question_type'] === "Link"){
        //     obj.metas[obj['project_id']].forEach((item) => {this.updateIndividualLink(obj['project_id'], i, item);});
        // }
        //console.log("updatingLinkmetas");
        
        
    },

    addtoForm: function (i) {  
        var arr = this.state.Questions;
        console.log(arr[i], arr);
        if (arr[i].hasOwnProperty('is_new')) {
            delete arr[i].is_new;
               
            arr.push({
                        "question_text": "",
                        "question_type": "Text",
                        "question_name": "",
                        "question_placeholder": "",
                        "question_help": "",
                        "is_new": true,
                    });
            console.log(arr);
            
            this.setState({Questions:arr});
        }
    },


    eachQuestion: function (is_new=false, id=false, question, i){
        
        console.log(is_new, id, question.question_name, i);

        if( (!question.hasOwnProperty('is_deleted') || (question.hasOwnProperty('is_deleted') && question.is_deleted == false)) && ( is_new  || !question.hasOwnProperty('is_new')) ){
            console.log(question);
            if(question.question_type=="MCQ" ){
                                     
                        var renderedQuestion= <MCQQuestion key={is_new?id:i} index={is_new?id:i} addtoForm={this.addtoForm} is_new={is_new} question_obj={question} options={question.mcq_options} question={question.question_text} question_type={question.question_type}  updateQuestionText={this.updateQuestion} updateMCQOptions={this.updateMCQOptions} deleteFromForm={this.removeQuestion} />
                        
                  
            }
            else if(question.question_type=="Link"){
               
                        var renderedQuestion= <ExtLinkQuestion key={is_new?id:i} index={is_new?id:i} addtoForm={this.addtoForm} is_new={is_new} question_obj={question} question={question.question_text} question_type={question.question_type}  updateQuestionText={this.updateQuestion} updateLinkProject={this.updateLinkProject} link_project_id ={question.project_id} updateLinkMetas={this.updateLinkMetas} selected_metas={question.metas} deleteFromForm={this.removeQuestion} selectedProjectLinkIds={this.state.selectedProjectLinkIds} projects={this.state.projects} />                        
                        
                   
            }
            else if(question.question_type=="FormSubStat"){
                
                       
                        var renderedQuestion= <FormSubStatQuestion key={is_new?id:i} index={is_new?id:i} addtoForm={this.addtoForm} is_new={is_new} question_obj={question} question={question.question_text} question_type={question.question_type}  updateQuestionText={this.updateQuestion} updateForm={this.updateForm} link_form_id ={question.form_id} deleteFromForm={this.removeQuestion} forms={this.state.forms} />                        
                        
                   
            }
            else if(question.question_type=="Form"){
                
                        
                        var renderedQuestion= <FormQuestion key={is_new?id:i} index={is_new?id:i} addtoForm={this.addtoForm} is_new={is_new} question_obj={question} question={question.question_text} question_type={question.question_type}  updateQuestionText={this.updateQuestion} updateForm={this.updateForm} link_form_id ={question.form_id} updateSQuestion={this.updateSQuestion} selected_question={question.question.name} deleteFromForm={this.removeQuestion} forms={this.state.forms} />                        
                       
                  
            }
            else{

                        var renderedQuestion= <NormalQuestion key={is_new?id:i} index={is_new?id:i} addtoForm={this.addtoForm} is_new={is_new} question_obj={question} question={question.question_text} question_type={question.question_type}  updateQuestionText={this.updateQuestion} deleteFromForm={this.removeQuestion} />
                       
                
            }
            if(question.hasOwnProperty('is_new')){
                return (
                   
                        renderedQuestion 
                   
                    );
            }else{
                return (
                    <li className="ui-sortable-handle" key={is_new?id:i} data-id={is_new?id:i}
                          draggable='true'
                          onDragEnd={this.dragEnd.bind(this)}
                          onDragStart={this.dragStart.bind(this)}>
                        { renderedQuestion }
                    </li>

                );}
        }
    },

    render: function () {
        var listItems = this.state.Questions.map(this.eachQuestion.bind(this, false, false));
        return (

            <div>
            <header className="panel-heading clearfix">
                <h3><i className="la la-cogs"></i>Site Meta Attributes</h3>

                <button onClick={this.save.bind()} className="btn btn-success pull-right"><i className="la la-save"></i>Save Form</button>
            </header>
            <div className="panel-body">
                <div className="row">
                    <div className="col-md-4">
                        <div className="">
                            {   
                                [this.state.Questions[this.state.Questions.length - 1]].map(this.eachQuestion.bind(this, true, this.state.Questions.length - 1))
                            }  
                        </div>
                    </div>
                    <div className="col-md-8">
                        <ul id="hero" className="hero form-field-list bg-gray margin-top ui-sortable" onDragOver={this.dragOver.bind(this)}>
                            {   
                                listItems
                            }
                        </ul>
                        
                    </div>
                </div>
            </div>
            </div>
            );
        }
    });

    ReactDOM.render(<Form /> , document.getElementById('app'));

</script> 
<script type="text/javascript">
    $('.selectize').selectize();
</script>
{% endblock %}


